import numpy as np
from matplotlib import pyplot as plt  #绘图

'''
Function: Find the peck of the curve
Ye's demo code
'''
# matplotlib.use('TkAgg')
def thresholding_algo(y, lag, threshold, influence):
    signals = np.zeros(len(y))
    filteredY = np.array(y)
    avgFilter = [0]*len(y)
    stdFilter = [0]*len(y)
    avgFilter[lag - 1] = np.mean(y[:lag])
    stdFilter[lag - 1] = np.std(y[:lag])
    for i in range(lag, len(y) - 1):
        if abs(y[i] - avgFilter[i-1]) > threshold * stdFilter [i-1]:
            signals[i] = 1 if y[i] > avgFilter[i-1] else -1
            filteredY[i] = influence * y[i] + (1 - influence) * filteredY[i-1]
        else:
            signals[i] = 0
            filteredY[i] = y[i]
        avgFilter[i] = np.mean(filteredY[(i-lag):i])
        stdFilter[i] = np.std(filteredY[(i-lag):i])
    return dict(signals = np.asarray(signals),
                avgFilter = np.asarray(avgFilter),
                stdFilter = np.asarray(stdFilter))
 
 
 
# Example kpi Data, the actual data for 1 min vibration will be much longer than this one
y=np.array([-16.165,-17.507,-18.849,-20.923,-18.3,-19.093,-17.446,-19.459,-15.921,-16.836,-17.873,-13.847,-20.252,-18.91,-21.045,-18.422,-18.239,-19.093,-18.91,-19.032,-18.361,-23.851,-19.703,-19.459,-13.847,-21.594,-19.398,-18.727,-19.947,-19.215,-14.823,-17.385,-17.751,-19.703,-17.202,-17.69,-15.799,-15.738,-18.91,-18.422,-19.825,-20.374,-17.019,-22.082,-22.692,-19.52,-22.143,-17.873,-21.655,-17.995,-18.117,-17.995,-20.191,-16.531,-17.873,-16.836,-18.239,-19.825,-16.531,-20.191,-16.409,-17.934,-12.261,-15.921,-18.605,-16.958,-19.032,-16.836,-22.204,-19.398,-17.751,-19.642,-20.374,-23.18,-18.483,-20.374,-19.459,-17.507,-18.666,-20.801,-22.509,-14.396,-17.263,-18.605,-14.152,-15.921,-17.995,-17.324,-13.908,-17.202,-18.788,-18.849,-16.958,-17.019,-19.581,-24.4,-18.3,-21.899,-19.276,-17.507,-20.679,-18.544,-13.115,-18.117,-17.812,-20.008,-18.605,-21.35,-20.496,-17.568,-19.398,-19.642,-19.093,-22.753,-20.923,-20.313,-21.167,-17.812,-16.47,-17.934,-18.178,-17.873,-19.947,-21.228,-18.361,-20.496,-20.801,-19.52,-19.154,-22.082,-22.692,-18.3,-14.701,-17.385,-19.947,-17.019,-17.08,-15.006,-17.934,-19.398,-16.47,-21.716,-18.727,-21.411,-18.422,-18.056,-16.348,-18.3,-19.703,-17.446,-21.167,-16.226,-16.775,-18.239,-17.934,-19.032,-15.433,-18.178,-16.653,-16.47,-18.91,-19.947,-22.692,-20.435,-19.032,-21.289,-18.666,-20.557,-17.995,-21.411,-22.448,-17.202,-17.507,-20.496,-22.631,-17.873,-19.337,-15.982,-17.751,-20.008,-16.104,-19.215,-16.592,-20.13,-21.106,-17.385,-23.546,-18.3,-18.788,-19.703,-16.348,-20.74,-21.35,-15.738,-18.666,-18.117,-19.52,-20.313,-16.104,-16.104,-18.361,-15.128,-17.08,-22.326,-17.507,-18.666,-15.921,-19.398,-19.764,-18.544,-18.483,-19.459,-20.557,-16.897,-22.753,-20.496,-19.886,-21.045,-19.337,-21.899,-19.703,-20.862,-19.947,-18.056,-17.934,-17.629,-16.897,-21.228,-23.729,-18.3,-20.252,-15.921,-20.496,-18.3,-17.812,-17.69,-15.982,-18.727,-21.106,-18.544,-19.703,-17.69,-17.385,-19.398,-21.533,-16.348,-21.899,-18.117,-19.032,-21.167,-19.215,-19.276,-19.093,-17.812,-17.507,-19.154,-20.679,-21.96,-21.228,-18.422,-19.581,-17.629,-21.289,-16.287,-20.435,-18.91,-19.276,-19.581,-17.69,-20.069,-19.398,-19.642,-18.605,-22.143,-19.337,-15.799,-22.875,-18.422,-19.398,-20.74,-18.483,-19.764,-20.435,-18.178,-19.764,-20.557,-19.459,-21.167,-19.52,-18.666,-14.762,-18.117,-17.873,-20.679,-21.106,-19.337,-22.814,-16.531,-18.605,-14.945,-19.276,-17.995,-18.666,-20.252,-16.043,-19.276,-22.509,-15.555,-21.045,-20.557,-21.655,-18.178,-22.021,-20.618,-22.631,-21.045,-19.886,-21.777,-18.971,-16.775,-19.886,-19.154,-20.313,-15.799,-16.104,-17.019,-17.324,-18.239,-18.605,-18.056,-19.642,-17.019,-16.592,-15.921,-19.52,-22.265,-19.886,-22.143,-20.13,-17.019,-19.581,-20.618,-19.642,-19.093,-19.154,-15.555,-18.544,-17.202,-21.167,-18.788,-16.897,-18.056,-19.032,-17.873,-20.557,-18.361,-18.727,-21.96,-20.618,-19.52,-17.263,-22.692,-21.777,-17.69,-20.374,-19.581,-17.69,-18.056,-20.923,-23.424,-16.043,-20.008,-21.411,-21.899,-17.629,-18.422,-17.324,-20.191,-17.385,-16.836,-20.191,-19.459,-21.96,-16.775,-17.019,-20.313,-18.849,-19.581,-19.093,-19.947,-21.96,-20.374,-16.531,-23.302,-19.947,-20.069,-18.483,-22.326,-19.886,-17.141,-17.263,-20.008,-18.117,-17.873,-20.801,-19.947,-21.777,-21.533,-17.507,-17.141,-19.398,-21.045,-18.056,-14.884,-22.143,-23.485,-20.496,-21.777,-20.313,-18.544,-21.045,-21.899,-20.008,-22.875,-17.873,-22.387,-20.008,-20.008,-21.838,-17.995,-17.873,-15.067,-17.629,-18.666,-18.544,-17.324,-17.69,-15.799,-20.313,-17.934,-19.215,-22.082,-17.202,-21.838,-23.119,-20.374,-23.119,-20.618,-20.069,-18.239,-17.873,-18.544,-18.605,-18.666,-20.069,-19.947,-19.093,-16.409,-19.947,-19.215,-18.544,-18.605,-20.74,-18.727,-20.557,-20.801,-18.3,-15.799,-16.287,-20.374,-18.849,-17.568,-20.435,-19.764,-21.899,-21.655,-17.934,-19.886,-19.459,-22.387,-20.984,-18.361,-21.472,-19.337,-16.226,-16.287,-19.032,-18.849,-20.191,-20.984,-18.91,-17.507,-21.777,-19.52,-20.557,-18.605,-18.971,-19.215,-19.581,-19.764,-20.008,-18.422,-20.069,-19.642,-21.594,-18.422,-19.276,-14.396,-19.581,-19.825,-20.008,-19.154,-18.483,-25.559,-21.655,-22.509,-19.215,-18.056,-18.666,-18.727,-18.91,-16.531,-18.422,-14.579,-20.435,-19.093,-15.799,-19.032,-21.167,-23.363,-20.618,-20.374,-21.655,-21.594,-20.069,-19.642,-24.766,-16.47,-21.228,-19.337,-19.764,-21.106,-18.727,-21.594,-19.886,-18.117,-15.494,-19.825,-15.738,-18.483,-19.52,-16.226,-16.043,-20.008,-16.958,-21.838,-15.555,-21.35,-18.361,-16.47,-19.52,-20.496,-18.849,-16.775,-19.581,-20.191,-19.276,-19.825,-17.202,-18.849,-17.507,-20.862,-18.483,-14.64,-17.568,-17.751,-16.104,-17.202,-14.396,-19.398,-18.178,-20.923,-19.581,-22.814,-18.483,-18.91,-16.226,-20.679,-19.398,-18.666,-23.119,-19.032,-22.082,-16.775,-21.045,-19.093,-19.52,-15.067,-21.716,-14.518,-19.459,-16.47,-17.507,-18.239,-21.838,-23.729,-20.923,-19.459,-19.886,-18.605,-17.202,-20.13,-20.618,-16.348,-19.642,-18.91,-17.202,-22.814,-20.252,-22.265,-22.326,-20.557,-17.263,-20.191,-17.873,-20.74,-18.178,53.314,-73.444,-16.348,-8.906,-129.93,75.457,23.18,-34.892,-73.139,-14.152,-5.673,4.697,-43.371,-21.411,-38.308,-16.348,-13.115,-16.836,-24.095,-21.167,-24.766,-13.115,-24.156,-11.651,-24.4,-18.971,-17.507,-21.899,-4.758,-24.766,-13.847,-22.509,-15.494,-13.298,-16.104,-22.448,-18.3,-30.439,-8.479,-24.278,-20.008,-19.764,-16.348,-11.956,-18.361,-19.764,-15.555,-24.766,-17.751,-22.448,-15.86,-21.533,-15.067,-22.021,-20.313,191.601,-45.323,36.6,-2.684,-33.916,-14.03,-4.941,-26.23,-25.254,-26.474,-16.165,-20.252,-39.772,-28.121,-15.555,-16.47,-20.13,-22.021,-11.346,-16.043,-7.93,-7.564,-16.714,-12.2,-24.278,-12.505,-15.433,-25.193,-21.96,-25.925,-20.496,-22.509,-26.047,-21.106,-29.951,-19.581,-25.193,-13.115,-18.605,-21.228,-21.838,-13.664,-20.313,-16.348,-26.413,-19.581,-25.193,-16.043,-12.383,-18.727,-17.08,-22.082,-11.834,-15.067,-19.947,-14.274,-17.202,-15.372,-22.631,-25.437,-21.533,-24.278,-21.228,-10.98,-23.424,-29.402,-25.986,-22.387,-18.117,-18.788,-21.167,-23.302,-22.631,-10.797,-13.786,-13.725,-19.581,-19.093,-15.982,-21.655,-12.749,-11.224,-19.032,-17.812,-18.239,-18.91,-22.936,-12.81,-19.459,-22.387,-16.836,-19.886,-15.494,-15.555,-20.984,-19.154,-19.154,-17.08,-14.274,-23.79,-20.435,-22.692,-17.507,-20.679,-19.886,-18.727,-22.021,-16.592,-20.496,-13.786,-13.176,-22.143,-19.886,-22.265,-16.226,-11.834,-9.089,-13.298,-11.346,-17.324,-18.178,-23.729,-15.494,-23.363,-17.751,-16.653,-20.923,-12.932,-26.596,-32.025,-25.254,-11.163,-21.167,-18.361,-30.012,-13.359,-19.032,-17.385,-18.666,-12.139,-17.507,-17.873,-15.677,-11.224,-23.119,-13.237,-13.42,-8.296,-16.836,-7.808,-13.847,-14.762,-14.518,-18.605,-24.827,-27.572,-24.278,-18.056,-20.252,-17.69,-8.54,-20.191,-21.777,-19.032,-14.579,-18.666,-15.799,-18.117,-11.956,-22.814,-16.165,-16.714,-11.163,-21.35,-19.581,-19.276,-10.736,-22.082,-11.59,-23.546,-9.577,-19.337,-18.056,-22.875,-19.032,-15.128,-19.459,-16.348,-20.13,-21.594,-20.862,-16.775,-24.339,-13.115,-23.607,-17.263,-19.215,-14.945,-30.012,-18.117,-27.145,-20.74,-19.52,-15.555,-22.936,-22.57,-23.302,-11.529,-12.871,-17.873,-23.119,-22.082,-8.418,-15.006,-12.993,-20.862,-12.627,-23.973,-15.616,-16.775,-10.858,-20.679,-12.993,-28.487,-19.581,-28.67,-11.834,-29.707,-11.224,-23.607,-16.226,-27.267,-15.677,-28.792,-18.727,-31.171,-21.228,-26.291,-15.86,-21.167,-17.812,-21.716,-15.25,-22.448,-16.104,-14.701,-15.311,-15.677,-22.021,-16.043,-22.631,-15.616,-23.485,-18.849,-26.108,-17.446,-26.718,-5.185,-22.265,-15.738,-23.485,-15.311,-20.252,-20.679,-14.884,-17.995,-25.254,-24.156,-16.897,-18.361,-12.505,-24.4,-15.128,-24.888,-6.954,-23.607,-16.165,-26.352,-13.603,-28.975,-10.431,-24.583,-13.054,-27.572,-11.163,-24.766,-16.592,-31.049,-10.065,-26.23,-7.503,-27.633,-17.69,-20.74,-19.093,-29.036,-17.202,-17.69,-17.08,-26.718,-19.276,-15.311,-19.398,-24.461,-24.949,-19.398,-25.01,-18.483,-21.228,-12.078,-26.291,-13.725,-26.108,-12.871,-24.705,-4.209,-29.951,-12.871,-19.703,-14.884,-18.727,-19.276,-18.544,-20.069,-9.516,-26.84,-9.516,-24.644,-14.274,-23.424,-6.283,-25.986,-10.553,-26.779,-9.211,-25.01,-11.224,-29.341,-5.307,-21.96,-14.03,-29.097,-9.516,-29.585,-6.039,-31.964,-8.967,-24.217,-11.224,-13.969,-8.418,-18.3,-11.041,-19.886,-22.936,-14.64,-19.703,-9.577,-21.716,-16.47,-31.903,-14.03,-19.093,-8.052,-31.72,-12.81,-28.182,-5.673,-19.581,-5.307,-30.622,-8.235,-30.073,-6.405,-19.093,-2.501,-22.997,-12.871,-26.657,-25.437,-11.285,-23.729,-11.041,-29.768,-10.675,-30.073,-0.915,-26.23,-6.222,-33.611,-14.518,-28.487,-15.25,-21.899,-12.505,-27.755,-17.019,-23.912,-13.359,-24.949,-24.217,-23.973,-13.786,-22.692,-15.555,-13.725,-18.544,-26.596,-28.182,-6.527,-17.507,-18.117,-15.189,-16.348,-22.692,-16.287,-25.864,-4.758,-23.973,-13.42,-28.182,-15.189,-19.703,-8.662,-23.607,-11.468,-29.28,-7.32,-24.095,-12.993,-28.243,-7.625,-24.095,-17.141,-27.938,-15.067,-24.705,-10.675,-11.163,-10.675,-16.043,-21.655,-20.191,-27.572,-11.285,-20.252,-13.542,-31.72,-19.459,-28.731,-15.616,-23.729,-9.882,-24.461,-16.958,-20.74,-22.082,-19.337,-19.337,-22.204,-19.825,-21.35,-26.718,-20.984,-18.178,-17.08,-30.317,-25.01,-40.016,-16.348,-19.398,-10.492,-24.278,-18.056,-26.901,-11.712,-29.28,-13.42,-28.975,-8.479,-23.058,-7.381,-21.289,-7.564,-22.631,-8.723,-32.025,-22.021,-34.831,-21.594,-20.984,-3.904,-17.507,-10.614,-26.779,-10.919,-23.302,-18.727,-21.899,-19.886,-16.897,-13.664,-16.775,-27.755,-15.067,-22.387,-8.113,-22.326,-13.786,-22.204,-6.039,-16.531,-14.091,-23.302,-17.019])


# Settings: lag = 30, threshold = 8, influence = 0
lag = 30
threshold = 8
influence = 0
 
# Run algo with settings from above
result = thresholding_algo(y, lag=lag, threshold=threshold, influence=influence)
 
# decompose results, peak_loc is what we need for next step counting
result_step = abs(result["signals"])
index_array = np.arange(len(result_step))
peak_loc = index_array[result_step == 1.0]


plt.plot(y)
plt.plot(peak_loc,y[peak_loc],'o')
plt.show()